---
import BaseLayout from '../layouts/BaseLayout.astro';

const title = 'Search | 唐靖凯';
const description = '站内搜索（离线索引，纯静态）。';

// NOTE: import.meta.env is only guaranteed during build-time.
// We inline BASE_URL into the page so the browser doesn't depend on Vite env injection.
const BASE_URL = import.meta.env.BASE_URL;
---

<BaseLayout title={title} description={description}>
  <Fragment slot="head">
    <link rel="stylesheet" href={`${import.meta.env.BASE_URL}pagefind/pagefind-ui.css`} />
  </Fragment>

  <section class="section glass" style="max-width: 980px;">
    <h1 class="post-title" style="margin-top: 0;">Search</h1>
    <p class="post-meta">纯静态搜索（Pagefind），不需要后端。</p>

    <div id="pagefind" class="post-content"></div>
  </section>

  <script is:inline type="module" define:vars={{ BASE_URL }}>
    // Pagefind UI script is NOT an ES module; it attaches PagefindUI to window.
    // We load it via a normal <script> injection, then instantiate window.PagefindUI.
    (async () => {
      const base = BASE_URL;
      try {
        const uiUrl = `${base}pagefind/pagefind-ui.js`;

        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = uiUrl;
          s.async = true;
          s.onload = () => resolve(null);
          s.onerror = () => reject(new Error(`Failed to load ${uiUrl}`));
          document.head.appendChild(s);
        });

        const UI = window.PagefindUI;
        if (!UI) throw new Error('PagefindUI not found on window after loading script');

        new UI({
          element: '#pagefind',
          showSubResults: true,
        });
      } catch (e) {
        const el = document.querySelector('#pagefind');
        if (el) {
          el.textContent = '';
          const p = document.createElement('p');
          p.append(document.createTextNode('搜索组件加载失败：请确认构建产物包含 '));
          const code = document.createElement('code');
          code.textContent = '/pagefind';
          p.append(code);
          p.append(document.createTextNode(' 目录。'));
          el.appendChild(p);
        }
        console.error('[search] failed to load pagefind', e);
      }
    })();
  </script>
</BaseLayout>
