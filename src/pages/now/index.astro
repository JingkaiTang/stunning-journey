---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import PostCard from '../../components/PostCard.astro';
import { pickCover, resolveMaybeRelativeUrl } from '../../utils/contentPreview';
import { formatShanghai } from '../../utils/dateFormat';

const posts = (await getCollection('now'))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
---

<BaseLayout title="Now | 唐靖凯" description="我最近在做什么（短更新）">
  <section class="section glass" style="max-width: 900px;">
    <h2>Now</h2>

    <div style="margin-top: 24px; display: grid; gap: 16px;">
      {posts.map((post) => {
        const href = `/now/${post.slug.replace(/\/index$/, '')}/`;
        const coverRaw = pickCover(post);
        const cover = coverRaw ? resolveMaybeRelativeUrl(coverRaw, href) : null;
        return (
          <PostCard
            href={href}
            title={`${formatShanghai(post.data.pubDate, { withSeconds: true })} · ${post.data.title.replace(/^Now:\s*/, '')}`}
            description={post.data.description}
            cover={cover}
            kindLabel="Now"
          >
            <Fragment slot="meta">
              <a href={href}>阅读全文 →</a>
              <a href="/tags/now/" style="color: var(--muted);">#now</a>
            </Fragment>
          </PostCard>
        );
      })}

      {posts.length === 0 ? <p style="color: var(--muted);">还没有 Now 更新。</p> : null}
    </div>
  </section>
</BaseLayout>
