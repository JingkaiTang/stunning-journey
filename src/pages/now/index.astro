---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { pickCover, resolveMaybeRelativeUrl } from '../../utils/contentPreview';

const posts = (await getCollection('now'))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
---

<BaseLayout title="Now | 唐靖凯" description="我最近在做什么（短更新）">
  <section class="section glass" style="max-width: 900px;">
    <h2>Now</h2>
    <p style="color: var(--muted); margin-top: 10px;">
      这里是短更新区：记录我最近在做什么、学到什么、下一步计划。<br />
      规则：Now 独立为 content collection（`src/content/now/`），每条带 tag：<code>now</code>。
    </p>

    <div style="margin-top: 24px; display: grid; gap: 16px;">
      {posts.map((post) => {
        const href = `/now/${post.slug.replace(/\/index$/, '')}/`;
        const coverRaw = pickCover(post);
        const cover = coverRaw ? resolveMaybeRelativeUrl(coverRaw, href) : null;
        return (
          <article class="project-card content-card">
            <div class={`content-card__grid ${cover ? 'has-cover' : ''}`}>
              {cover ? (
                <a href={href} style="display:block;">
                  <img
                    class="content-card__thumb"
                    src={cover}
                    alt={post.data.title}
                    loading="lazy"
                  />
                </a>
              ) : null}

              <div>
                <div style="display:flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 8px;">
                  <h3 style="margin:0;">
                    <a href={`/now/${post.slug.replace(/\/index$/, '')}/`} style="color: var(--text); text-decoration:none;">
                      {post.data.pubDate.toISOString().slice(0, 10)} · {post.data.title.replace(/^Now:\s*/, '')}
                    </a>
                  </h3>
                  <span style="color: var(--primary); font-size: 0.85rem;">Now</span>
                </div>

                {post.data.description ? <p style="margin-top: 8px; color: var(--muted);">{post.data.description}</p> : null}

                <div style="margin-top: 10px; display:flex; gap: 10px; flex-wrap: wrap;">
                  <a href={`/now/${post.slug.replace(/\/index$/, '')}/`}>阅读全文 →</a>
                  <a href="/tags/now/" style="color: var(--muted);">#now</a>
                </div>
              </div>
            </div>
          </article>
        );
      })}

      {posts.length === 0 ? <p style="color: var(--muted);">还没有 Now 更新。</p> : null}
    </div>
  </section>
</BaseLayout>
