---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { formatShanghai } from '../../utils/dateFormat';

export async function getStaticPaths() {
  // Include drafts so they can be previewed via direct link.
  // Drafts are still hidden from feeds/lists elsewhere.
  const posts = await getCollection('now');
  return posts.map((p) => ({
    params: { slug: p.slug.replace(/\/index$/, '') },
    props: { post: p },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);
const isDraft = Boolean(post.data.draft);
---

<BaseLayout
  title={`${post.data.title}${isDraft ? '（草稿）' : ''} | 唐靖凯`}
  description={post.data.description}
  canonical={`/now/${post.slug.replace(/\/index$/, '')}/`}
  ogType="article"
  publishedTime={post.data.pubDate.toISOString()}
>
  <Fragment slot="head">
    {isDraft ? <meta name="robots" content="noindex,nofollow" /> : null}
  </Fragment>

  <section class="section glass" style="max-width: 980px;">
    <article class="post">
      <div style="display:flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <h1 class="post-title" style="margin:0;">{post.data.title}</h1>
        {isDraft ? (
          <span style="
            font-size: 0.85rem;
            color: var(--primary);
            border: 1px solid rgba(124, 249, 255, 0.25);
            border-radius: 999px;
            padding: 2px 10px;
            background: rgba(124, 249, 255, 0.08);
          ">草稿</span>
        ) : null}
      </div>

      {isDraft ? (
        <p style="margin-top: 10px; color: var(--muted);">
          这是一条草稿：仅用于预览，不会出现在 Now 列表/首页流中。
        </p>
      ) : null}

      <p class="post-meta">
        {formatShanghai(post.data.pubDate, { withSeconds: true })}
        {post.data.updatedDate ? (
          <>
            {' '}· 更新于 {formatShanghai(post.data.updatedDate, { withSeconds: true })}
          </>
        ) : null}
        {post.data.tags.length ? (
          <> · {post.data.tags.map((t, i) => (
            <>
              <a href={`/tags/${encodeURIComponent(t)}/`}>{t}</a>
              {i < post.data.tags.length - 1 ? ' / ' : ''}
            </>
          ))}</>
        ) : null}
      </p>

      <div class="post-content">
        <Content />
      </div>

      <p style="margin-top: 18px;"><a href="/now">← 返回 Now</a></p>
    </article>
  </section>
</BaseLayout>
