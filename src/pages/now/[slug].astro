---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { formatShanghai } from '../../utils/dateFormat';

export async function getStaticPaths() {
  // Include drafts so they can be previewed via direct link.
  // Drafts are still hidden from feeds/lists elsewhere.
  const posts = await getCollection('now');
  return posts.map((p) => ({
    params: { slug: p.slug.replace(/\/index$/, '') },
    props: { post: p },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);
const isDraft = Boolean(post.data.draft);
---

<BaseLayout
  title={`${post.data.title}${isDraft ? '（草稿）' : ''} | 唐靖凯`}
  description={post.data.description}
  canonical={`/now/${post.slug.replace(/\/index$/, '')}/`}
  ogType="article"
  publishedTime={post.data.pubDate.toISOString()}
>
  <Fragment slot="head">
    {isDraft ? <meta name="robots" content="noindex,nofollow" /> : null}
  </Fragment>

  <section class="section glass detail-section">
    <article class="post">
      <div class="detail-title-row">
        <h1 class="post-title detail-title">{post.data.title}</h1>
        {isDraft ? (
          <span class="detail-draft-badge">草稿</span>
        ) : null}
      </div>

      {isDraft ? (
        <p class="detail-note">
          这是一条草稿：仅用于预览，不会出现在 Now 列表/首页流中。
        </p>
      ) : null}

      <p class="post-meta detail-meta">
        {formatShanghai(post.data.pubDate, { withSeconds: true })}
        {post.data.updatedDate ? (
          <>
            {' '}· 更新于 {formatShanghai(post.data.updatedDate, { withSeconds: true })}
          </>
        ) : null}
        {post.data.tags.length ? (
          <> · {post.data.tags.map((t, i) => (
            <>
              <a href={`/tags/${encodeURIComponent(t)}/`}>{t}</a>
              {i < post.data.tags.length - 1 ? ' / ' : ''}
            </>
          ))}</>
        ) : null}
      </p>

      <div class="post-content detail-content">
        <Content />
      </div>

      <p class="detail-back"><a href="/now">← 返回 Now</a></p>
    </article>
  </section>
</BaseLayout>
