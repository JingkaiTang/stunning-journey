---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('writing');
  return posts
    .filter((p) => !p.data.draft)
    .map((p) => ({
      params: { slug: p.slug.replace(/\/index$/, '') },
      props: { post: p },
    }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

const toc = (headings ?? []).filter((h) => h.depth >= 2 && h.depth <= 3);
---

<BaseLayout
  title={`${post.data.title} | 唐靖凯`}
  description={post.data.description}
  canonical={`/writing/${post.slug.replace(/\/index$/, '')}/`}
  ogType="article"
  publishedTime={post.data.pubDate.toISOString()}
>
  <section class="section glass" style="max-width: 980px;">
    <div class="post-shell">
      <article class="post">
        <h1 class="post-title">{post.data.title}</h1>
        <p class="post-meta">
          {post.data.pubDate.toISOString().slice(0, 10)}
          {post.data.tags.length ? (
            <> · {post.data.tags.map((t, i) => (
              <>
                <a href={`/tags/${encodeURIComponent(t)}/`}>{t}</a>
                {i < post.data.tags.length - 1 ? ' / ' : ''}
              </>
            ))}</>
          ) : null}
        </p>

        <div class="post-content">
          <Content />
        </div>
      </article>

      {toc.length ? (
        <aside class="toc">
          <div class="toc-title">目录</div>
          <ol>
            {toc.map((h) => (
              <li class={h.depth === 3 ? 'd3' : 'd2'}>
                <a href={`#${h.slug}`}>{h.text}</a>
              </li>
            ))}
          </ol>
        </aside>
      ) : null}
    </div>
  </section>
</BaseLayout>
