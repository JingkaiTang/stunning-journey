---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { formatShanghai } from '../../utils/dateFormat';

export async function getStaticPaths() {
  // Include drafts so they can be previewed via direct link.
  // Drafts are still hidden from feeds/lists elsewhere.
  const posts = await getCollection('writing');
  return posts.map((p) => ({
    params: { slug: p.slug.replace(/\/index$/, '') },
    props: { post: p },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

const toc = (headings ?? []).filter((h) => h.depth >= 2 && h.depth <= 3);
const isDraft = Boolean(post.data.draft);
---

<BaseLayout
  title={`${post.data.title}${isDraft ? '（草稿）' : ''} | 唐靖凯`}
  description={post.data.description}
  canonical={`/writing/${post.slug.replace(/\/index$/, '')}/`}
  ogType="article"
  publishedTime={post.data.pubDate.toISOString()}
>
  <Fragment slot="head">
    {isDraft ? <meta name="robots" content="noindex,nofollow" /> : null}
  </Fragment>

  <section class="section glass" style="max-width: 980px;">
    <div class="post-shell">
      <article class="post">
        <div style="display:flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <h1 class="post-title" style="margin:0;">{post.data.title}</h1>
          {isDraft ? (
            <span style="
              font-size: 0.85rem;
              color: var(--primary);
              border: 1px solid rgba(124, 249, 255, 0.25);
              border-radius: 999px;
              padding: 2px 10px;
              background: rgba(124, 249, 255, 0.08);
            ">草稿</span>
          ) : null}
        </div>

        {isDraft ? (
          <p style="margin-top: 10px; color: var(--muted);">
            这是一篇草稿：仅用于预览，不会出现在首页/列表流中。
          </p>
        ) : null}
        <p class="post-meta">
          {formatShanghai(post.data.pubDate, { withSeconds: true })}
          {post.data.updatedDate ? (
            <>
              {' '}· 更新于 {formatShanghai(post.data.updatedDate, { withSeconds: true })}
            </>
          ) : null}
          {post.data.tags.length ? (
            <> · {post.data.tags.map((t, i) => (
              <>
                <a href={`/tags/${encodeURIComponent(t)}/`}>{t}</a>
                {i < post.data.tags.length - 1 ? ' / ' : ''}
              </>
            ))}</>
          ) : null}
        </p>

        <div class="post-content">
          <Content />
        </div>
      </article>

      {toc.length ? (
        <aside class="toc">
          <div class="toc-title">目录</div>
          <ol>
            {toc.map((h) => (
              <li class={h.depth === 3 ? 'd3' : 'd2'}>
                <a href={`#${h.slug}`}>{h.text}</a>
              </li>
            ))}
          </ol>
        </aside>
      ) : null}
    </div>
  </section>
</BaseLayout>
