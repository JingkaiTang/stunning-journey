---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { pickCover, resolveMaybeRelativeUrl } from '../utils/contentPreview';
import { formatShanghai } from '../utils/dateFormat';
import pinsData from '../data/github-pins.json';
import galleryData from '../data/footer-gallery.json';

const title = '唐靖凯 | AI 文章与项目';
const description = '代码、游戏与臭屁宝：Java后端工程师｜LLM应用侧实践｜主机游戏玩家｜新手奶爸';

const writing = (await getCollection('writing')).filter((p) => !p.data.draft);
const now = (await getCollection('now')).filter((p) => !p.data.draft);

const feed = [...writing.map((p) => ({ kind: 'writing' as const, post: p })), ...now.map((p) => ({ kind: 'now' as const, post: p }))]
  .sort((a, b) => b.post.data.pubDate.getTime() - a.post.data.pubDate.getTime())
  .slice(0, 10);

const pinned = (pinsData?.pins || []).slice(0, 6);
---

<BaseLayout title={title} description={description}>
  <section class="hero" style="padding-top: 12px;">
    <div class="hero-content">
      <p class="eyebrow">代码、游戏与臭屁宝</p>
      <h1>
        我是<span>唐靖凯</span>。
        <br />做工程，也做落地。
      </h1>

      <img class="avatar" src="/images/avatar.jpg" alt="唐靖凯" loading="eager" decoding="async" fetchpriority="high" />
      <p class="lead">
        Java 后端工程师（2018–），关注 LLM 应用落地与自动化。
        这里主要写：工程笔记、Agent/AI 实践、主机游戏、以及奶爸日常。
      </p>

      <div class="hero-actions">
        <a class="primary" href="/writing">阅读文章</a>
        <a class="ghost" href="/now">最近在干嘛</a>
        <a class="ghost" href="#projects">项目</a>
      </div>
    </div>

    <div class="hero-card">
      <div class="pulse"></div>
      <div class="card-header">
        <span>快速入口</span>
        <span class="status">Links</span>
      </div>
      <h3>导航</h3>
      <ul>
        <li><a class="signature" href="/writing">Writing →</a></li>
        <li><a class="signature" href="/now">Now →</a></li>
        <li><a class="signature" href="/search">Search →</a></li>
        <li><a class="signature" href="/rss.xml">RSS →</a></li>
        <li><a class="signature" href="https://github.com/JingkaiTang" target="_blank" rel="noreferrer">GitHub →</a></li>
      </ul>
      <div class="card-footer">
        <span>说明</span>
        <span>尽量少废话，直接给内容。</span>
      </div>
    </div>
  </section>

  <section id="latest" class="section">
    <div class="section-head">
      <h2>最新</h2>
      <p>Writing + Now 混合流（按时间倒序，展示最近 10 条）</p>
    </div>

    <div style="display:grid; gap:16px;">
      {feed.map(({ kind, post }) => {
        const href = kind === 'writing' ? `/writing/${post.slug.replace(/\/index$/, '')}/` : `/now/${post.slug.replace(/\/index$/, '')}/`;
        const title = kind === 'now' ? post.data.title.replace(/^Now:\s*/, '') : post.data.title;
        const coverRaw = pickCover(post);
        const cover = coverRaw ? resolveMaybeRelativeUrl(coverRaw, href) : null;
        return (
          <article class="feed-card project-card content-card">
            <div class={`content-card__grid ${cover ? 'has-cover' : ''}`}>
              {cover ? (
                <a href={href} style="display:block;">
                  <img
                    class="content-card__thumb"
                    src={cover}
                    alt={title}
                    loading="lazy"
                    decoding="async"
                    fetchpriority="low"
                  />
                </a>
              ) : null}

              <div>
                <div style="display:flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 8px;">
                  <h3 style="margin:0;">
                    <a href={href} style="color: var(--text); text-decoration:none;">
                      {title}
                    </a>
                  </h3>
                  <span style="color: var(--primary); font-size: 0.85rem;">{kind === 'now' ? 'Now' : 'Writing'}</span>
                </div>

                {post.data.description ? <p style="margin-top: 8px; color: var(--muted);">{post.data.description}</p> : null}

                <div style="margin-top: 10px; display:flex; gap: 10px; flex-wrap: wrap;">
                  <span style="color: var(--muted);">{formatShanghai(post.data.pubDate, { withSeconds: true })}</span>
                  <a href={href} aria-label={`阅读全文: ${title}`}>阅读全文 →</a>
                </div>
              </div>
            </div>
          </article>
        );
      })}

      {feed.length === 0 ? <p style="color: var(--muted);">还没有内容。</p> : null}
    </div>
  </section>

  <section id="projects" class="section">
    <div class="section-head">
      <h2>项目</h2>
      <p>
        <a href="https://github.com/JingkaiTang" target="_blank" rel="noreferrer">去 GitHub 看全部 →</a>
      </p>
    </div>

    <div class="project-grid">
      {pinned.map((r) => (
        <article class="project-card">
          <h3 style="margin-bottom: 8px;">
            <a href={r.url} target="_blank" rel="noreferrer" style="color: var(--text); text-decoration:none;">
              {r.name}
            </a>
          </h3>
          {r.description ? <p style="margin: 0 0 10px; color: var(--muted);">{r.description}</p> : <p style="margin: 0 0 10px; color: var(--muted);">（暂无描述）</p>}

          <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            {r.language ? (
              <span style="display:inline-flex; gap: 6px; align-items:center; color: var(--muted); font-size: 0.9rem;">
                <span style={`width:10px;height:10px;border-radius:999px;background:${r.languageColor || '#999'}; display:inline-block;`}></span>
                {r.language}
              </span>
            ) : null}
            <span style="color: var(--muted); font-size: 0.9rem;">★ {r.stars}</span>
            <span style="color: var(--muted); font-size: 0.9rem;">⑂ {r.forks}</span>
            {r.isArchived ? <span style="color: var(--muted); font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 999px;">Archived</span> : null}
          </div>

          {r.homepageUrl ? (
            <div style="margin-top: 10px;">
              <a href={r.homepageUrl} target="_blank" rel="noreferrer">项目主页 →</a>
            </div>
          ) : null}
        </article>
      ))}

      {pinned.length === 0 ? (
        <article class="project-card">
          <h3>项目</h3>
          <p style="color: var(--muted);">暂时没拉到 GitHub Pinned 仓库（可能是 token 不可用）。</p>
          <a href="https://github.com/JingkaiTang" target="_blank" rel="noreferrer">去 GitHub →</a>
        </article>
      ) : null}
    </div>
  </section>



  <section class="footer-gallery" aria-label="Vibe Mosaic" data-pagefind-ignore>
    <div class="footer-gallery__head">
      <h2>Vibe Mosaic</h2>
    </div>

    <div class="footer-gallery__grid" id="footer-gallery-grid">
      {((galleryData?.items || []) as any[]).map((it) => (
        <img class="footer-gallery__img" src={it.url} alt="" loading="lazy" decoding="async" />
      ))}
    </div>

    <script is:inline>
      (function () {
        const grid = document.getElementById('footer-gallery-grid');
        if (!grid) return;
        const imgs = Array.from(grid.querySelectorAll('img'));
        if (imgs.length === 0) return;

        // Fisher–Yates shuffle
        for (let i = imgs.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          const tmp = imgs[i];
          imgs[i] = imgs[j];
          imgs[j] = tmp;
        }

        const isMobile = window.matchMedia('(max-width: 560px)').matches;
        const isNarrow = window.matchMedia('(max-width: 900px)').matches;

        function clearSize(img) {
          img.classList.remove('is-wide', 'is-wide2', 'is-tall', 'is-big');
          img.style.gridColumn = '';
          img.style.gridRow = '';
        }

        // Mobile stays simple (2-col grid) and naturally grows; no need to force a flat bottom.
        if (isMobile) {
          const N = 14;
          function applySize(img, kind) {
            clearSize(img);
            if (!kind) return;
            img.classList.add(kind);
          }
          function pickKind() {
            const r = Math.random();
            if (r < 0.10) return 'is-big';
            if (r < 0.28) return 'is-tall';
            if (r < 0.48) return 'is-wide2';
            if (r < 0.60) return 'is-wide';
            return '';
          }

          const display = [];
          for (let i = 0; i < Math.min(imgs.length, N); i++) display.push(imgs[i]);
          while (display.length < N && imgs.length > 0) {
            const src = imgs[Math.floor(Math.random() * imgs.length)];
            const clone = src.cloneNode(true);
            clone.removeAttribute('data-astro-cid');
            display.push(clone);
          }

          imgs.forEach((img) => (img.style.display = 'none'));
          display.forEach((img) => {
            grid.appendChild(img);
            img.style.display = '';
            applySize(img, pickKind());
          });
          return;
        }

        // Desktop/tablet: use a few hand-crafted templates that *exactly* tile the grid.
        // This guarantees:
        // - no holes inside the mosaic
        // - a flat bottom edge (because the grid has fixed rows)
        const cols = isNarrow ? 8 : 12;

        /** placement: [colStart (1-based), rowStart (1-based), colSpan, rowSpan] */
        const templates12 = [
          // Template A: big anchors + lots of smalls
          [
            [1, 1, 4, 2], [5, 1, 3, 1], [8, 1, 3, 1], [11, 1, 2, 2],
            [5, 2, 2, 1], [7, 2, 2, 1], [9, 2, 2, 1],
            [1, 3, 2, 1], [3, 3, 2, 1], [5, 3, 2, 1], [7, 3, 2, 1], [9, 3, 2, 1], [11, 3, 2, 1],
          ],
          // Template B: more mid-size blocks
          [
            [1, 1, 3, 2], [4, 1, 2, 1], [6, 1, 2, 2], [8, 1, 3, 1], [11, 1, 2, 1],
            [4, 2, 2, 1], [8, 2, 3, 1], [11, 2, 2, 1],
            [1, 3, 2, 1], [3, 3, 3, 1], [6, 3, 2, 1], [8, 3, 2, 1], [10, 3, 3, 1],
          ],
          // Template C: a bit more chaotic, but still tiles the grid perfectly
          [
            [1, 1, 2, 2], [3, 1, 4, 1], [7, 1, 3, 2], [10, 1, 3, 1],
            [3, 2, 2, 1], [5, 2, 2, 1], [10, 2, 3, 1],
            [1, 3, 3, 1], [4, 3, 2, 1], [6, 3, 2, 1], [8, 3, 2, 1], [10, 3, 3, 1],
          ],
        ];

        const templates8 = [
          // 8 cols x 3 rows = 24 cells
          [
            [1, 1, 3, 2], [4, 1, 2, 1], [6, 1, 3, 1],
            [4, 2, 2, 1], [6, 2, 3, 1],
            [1, 3, 2, 1], [3, 3, 2, 1], [5, 3, 2, 1], [7, 3, 2, 1],
          ],
          [
            [1, 1, 2, 3], [3, 1, 3, 1], [6, 1, 3, 2],
            [3, 2, 3, 1],
            [3, 3, 2, 1], [5, 3, 2, 1], [7, 3, 2, 1],
          ],
        ];

        const pool = cols === 12 ? templates12 : templates8;
        const placement = pool[Math.floor(Math.random() * pool.length)];
        const N = placement.length;

        // Build exactly N tiles (clone nodes to allow repeats)
        const display = [];
        for (let i = 0; i < Math.min(imgs.length, N); i++) display.push(imgs[i]);
        while (display.length < N && imgs.length > 0) {
          const src = imgs[Math.floor(Math.random() * imgs.length)];
          const clone = src.cloneNode(true);
          clone.removeAttribute('data-astro-cid');
          display.push(clone);
        }

        imgs.forEach((img) => (img.style.display = 'none'));
        display.forEach((img, idx) => {
          const p = placement[idx];
          if (!p) return;
          clearSize(img);
          grid.appendChild(img);
          img.style.display = '';
          img.style.gridColumn = `${p[0]} / span ${p[2]}`;
          img.style.gridRow = `${p[1]} / span ${p[3]}`;
        });
      })();
    </script>
  </section>

</BaseLayout>
