---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { pickCover, resolveMaybeRelativeUrl } from '../utils/contentPreview';
import { formatShanghai } from '../utils/dateFormat';
import pinsData from '../data/github-pins.json';

const title = '唐靖凯 | AI 文章与项目';
const description = '代码、游戏与臭屁宝：Java后端工程师｜LLM应用侧实践｜主机游戏玩家｜新手奶爸';

const writing = (await getCollection('writing')).filter((p) => !p.data.draft);
const now = (await getCollection('now')).filter((p) => !p.data.draft);

const feed = [...writing.map((p) => ({ kind: 'writing' as const, post: p })), ...now.map((p) => ({ kind: 'now' as const, post: p }))]
  .sort((a, b) => b.post.data.pubDate.getTime() - a.post.data.pubDate.getTime())
  .slice(0, 10);

const pinned = (pinsData?.pins || []).slice(0, 6);
---

<BaseLayout title={title} description={description}>
  <section class="hero" style="padding-top: 12px;">
    <div class="hero-content">
      <p class="eyebrow">代码、游戏与臭屁宝</p>
      <h1>
        你好，我是<span>唐靖凯</span>。
        <br />写代码、打游戏、带娃。
      </h1>

      <img class="avatar" src="/images/avatar.jpg" alt="唐靖凯" loading="eager" decoding="async" fetchpriority="high" />
      <p class="lead">
        Java 后端工程师（2018 起全职）｜软件工程硕士。
        关注 AI 大模型应用侧：把新工具落到真实场景；也会记录主机游戏与奶爸日常。
      </p>
      <div class="hero-actions">
        <a class="primary" href="/writing">阅读文章</a>
        <a class="ghost" href="/now">最近在干嘛</a>
        <a class="ghost" href="#projects">项目</a>
      </div>
      <div class="hero-stats">
        <div>
          <strong>Java</strong>
          <span>后端</span>
        </div>
        <div>
          <strong>AI</strong>
          <span>应用</span>
        </div>
        <div>
          <strong>奶爸</strong>
          <span>臭屁宝</span>
        </div>
      </div>
    </div>

    <div class="hero-card">
      <div class="pulse"></div>
      <div class="card-header">
        <span>身份</span>
        <span class="status">程序员 / 玩家 / 奶爸</span>
      </div>
      <h3>Quick Facts</h3>
      <ul>
        <li>职业：Java 后端开发（2018–）</li>
        <li>方向：LLM 应用侧 / 工程落地 / 自动化</li>
        <li>兴趣：主机游戏</li>
        <li>家庭：新手奶爸（臭屁宝）</li>
      </ul>
      <div class="card-footer">
        <span>订阅</span>
        <a class="signature" href="/rss.xml">RSS</a>
      </div>
    </div>
  </section>

  <section id="about" class="section glass">
    <div>
      <h2>关于</h2>
      <p>
        这是一个“生活 + 工作 + 作品集”一体的个人站。
        我会把工程经验（Java/后端）、AI 应用侧实践、主机游戏体验、以及奶爸日常沉淀在这里。
        出于隐私考虑：只展示少量公开信息，敏感内容不进仓库、不上网页。
      </p>
    </div>
    <div class="metrics">
      <div>
        <h4>代码</h4>
        <p>Java 后端 / 工程化 / 可复现</p>
      </div>
      <div>
        <h4>AI</h4>
        <p>大模型应用侧 / Agent / 自动化</p>
      </div>
      <div>
        <h4>生活</h4>
        <p>主机游戏 / 奶爸（臭屁宝）</p>
      </div>
    </div>
  </section>

  <section id="latest" class="section">
    <div class="section-head">
      <h2>最新</h2>
      <p>Writing + Now 混合流（按时间倒序，展示最近 10 条）</p>
    </div>

    <div style="display:grid; gap:16px;">
      {feed.map(({ kind, post }) => {
        const href = kind === 'writing' ? `/writing/${post.slug.replace(/\/index$/, '')}/` : `/now/${post.slug.replace(/\/index$/, '')}/`;
        const title = kind === 'now' ? post.data.title.replace(/^Now:\s*/, '') : post.data.title;
        const coverRaw = pickCover(post);
        const cover = coverRaw ? resolveMaybeRelativeUrl(coverRaw, href) : null;
        return (
          <article class="feed-card project-card content-card">
            <div class={`content-card__grid ${cover ? 'has-cover' : ''}`}>
              {cover ? (
                <a href={href} style="display:block;">
                  <img
                    class="content-card__thumb"
                    src={cover}
                    alt={title}
                    loading="lazy"
                    decoding="async"
                    fetchpriority="low"
                  />
                </a>
              ) : null}

              <div>
                <div style="display:flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 8px;">
                  <h3 style="margin:0;">
                    <a href={href} style="color: var(--text); text-decoration:none;">
                      {title}
                    </a>
                  </h3>
                  <span style="color: var(--primary); font-size: 0.85rem;">{kind === 'now' ? 'Now' : 'Writing'}</span>
                </div>

                {post.data.description ? <p style="margin-top: 8px; color: var(--muted);">{post.data.description}</p> : null}

                <div style="margin-top: 10px; display:flex; gap: 10px; flex-wrap: wrap;">
                  <span style="color: var(--muted);">{formatShanghai(post.data.pubDate, { withSeconds: true })}</span>
                  <a href={href} aria-label={`阅读全文: ${title}`}>阅读全文 →</a>
                </div>
              </div>
            </div>
          </article>
        );
      })}

      {feed.length === 0 ? <p style="color: var(--muted);">还没有内容。</p> : null}
    </div>
  </section>

  <section id="projects" class="section">
    <div class="section-head">
      <h2>项目</h2>
      <p>
        同步自 GitHub 主页置顶（Pinned）仓库。
        <a href="https://github.com/JingkaiTang" target="_blank" rel="noreferrer">去 GitHub 看全部 →</a>
      </p>
    </div>

    <div class="project-grid">
      {pinned.map((r) => (
        <article class="project-card">
          <h3 style="margin-bottom: 8px;">
            <a href={r.url} target="_blank" rel="noreferrer" style="color: var(--text); text-decoration:none;">
              {r.name}
            </a>
          </h3>
          {r.description ? <p style="margin: 0 0 10px; color: var(--muted);">{r.description}</p> : <p style="margin: 0 0 10px; color: var(--muted);">（暂无描述）</p>}

          <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            {r.language ? (
              <span style="display:inline-flex; gap: 6px; align-items:center; color: var(--muted); font-size: 0.9rem;">
                <span style={`width:10px;height:10px;border-radius:999px;background:${r.languageColor || '#999'}; display:inline-block;`}></span>
                {r.language}
              </span>
            ) : null}
            <span style="color: var(--muted); font-size: 0.9rem;">★ {r.stars}</span>
            <span style="color: var(--muted); font-size: 0.9rem;">⑂ {r.forks}</span>
            {r.isArchived ? <span style="color: var(--muted); font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 999px;">Archived</span> : null}
          </div>

          {r.homepageUrl ? (
            <div style="margin-top: 10px;">
              <a href={r.homepageUrl} target="_blank" rel="noreferrer">项目主页 →</a>
            </div>
          ) : null}
        </article>
      ))}

      {pinned.length === 0 ? (
        <article class="project-card">
          <h3>项目</h3>
          <p style="color: var(--muted);">暂时没拉到 GitHub Pinned 仓库（可能是 token 不可用）。</p>
          <a href="https://github.com/JingkaiTang" target="_blank" rel="noreferrer">去 GitHub →</a>
        </article>
      ) : null}
    </div>
  </section>


</BaseLayout>
