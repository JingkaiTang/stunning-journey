---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { formatShanghai } from '../../utils/dateFormat';

type Item = {
  kind: 'writing' | 'now';
  slug: string;
  title: string;
  description?: string;
  pubDate: Date;
};

export async function getStaticPaths() {
  const writingPosts = (await getCollection('writing')).filter((p) => !p.data.draft);
  const nowPosts = (await getCollection('now')).filter((p) => !p.data.draft);

  const tagSet = new Set<string>();
  for (const p of [...writingPosts, ...nowPosts]) {
    for (const t of p.data.tags ?? []) tagSet.add(t);
  }

  // Ensure nav-linked tags always have a generated page, even if empty.
  // (Otherwise /tags/<tag>/ would 404 when there are currently no posts for that tag.)
  for (const t of ['ai', 'game', 'life']) tagSet.add(t);

  return [...tagSet].map((tag) => ({
    params: { tag: encodeURIComponent(tag) },
    props: { tag },
  }));
}

const { tag } = Astro.props;

const writingPosts = (await getCollection('writing'))
  .filter((p) => !p.data.draft)
  .filter((p) => (p.data.tags ?? []).includes(tag))
  .map((p) => ({
    kind: 'writing',
    slug: p.slug.replace(/\/index$/, ''),
    title: p.data.title,
    description: p.data.description,
    pubDate: p.data.pubDate,
  } satisfies Item));

const nowPosts = (await getCollection('now'))
  .filter((p) => !p.data.draft)
  .filter((p) => (p.data.tags ?? []).includes(tag))
  .map((p) => ({
    kind: 'now',
    slug: p.slug.replace(/\/index$/, ''),
    title: p.data.title,
    description: p.data.description,
    pubDate: p.data.pubDate,
  } satisfies Item));

const posts = [...writingPosts, ...nowPosts].sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime());
---

<BaseLayout title={`${tag} | Tags | 唐靖凯`} description={`标签：${tag}`}>
  <section class="section glass" style="max-width: 900px;">
    <div class="section-head">
      <h2>#{tag}</h2>
      <p>{posts.length} 条</p>
    </div>

    <div style="display:grid; gap:16px; margin-top: 12px;">
      {posts.map((post) => (
        <article class="project-card" style="transform:none;">
          <h3 style="margin-bottom: 6px;">
            <a
              href={post.kind === 'now' ? `/now/${post.slug}/` : `/writing/${post.slug}/`}
              style="color: var(--text); text-decoration:none;"
            >
              {post.kind === 'now' ? 'Now · ' : ''}{post.title.replace(/^Now:\s*/, '')}
            </a>
          </h3>
          {post.description ? <p style="color: var(--muted);">{post.description}</p> : null}
          <span style="color: var(--muted);">
            {formatShanghai(post.pubDate, { withSeconds: true })}
            {' · '}
            {post.kind}
          </span>
        </article>
      ))}
    </div>

    <p style="margin-top: 18px;"><a href="/tags">← 返回标签列表</a></p>
  </section>
</BaseLayout>
