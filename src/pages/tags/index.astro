---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const writingPosts = (await getCollection('writing')).filter((p) => !p.data.draft);
const nowPosts = (await getCollection('now')).filter((p) => !p.data.draft);

const posts = [...writingPosts, ...nowPosts];

const tagCounts = new Map<string, number>();
for (const p of posts) {
  for (const t of p.data.tags ?? []) {
    tagCounts.set(t, (tagCounts.get(t) ?? 0) + 1);
  }
}

const tags = [...tagCounts.entries()].sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));
---

<BaseLayout title="Tags | 唐靖凯" description="标签（Writing + Now）">
  <section class="section glass" style="max-width: 900px;">
    <div class="section-head">
      <h2>Tags</h2>
      <p>按标签浏览 Writing / Now。</p>
    </div>

    <div style="display:grid; gap:16px; margin-top: 16px;">
      {tags.map(([tag, count]) => (
        <article class="project-card content-card">
          <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
            <h3 style="margin:0;">
              <a href={`/tags/${encodeURIComponent(tag)}/`} style="color: var(--text); text-decoration:none;">
                #{tag}
              </a>
            </h3>
            <span style="color: var(--muted); font-size: 0.95rem;">{count} 条</span>
          </div>
          <div style="margin-top: 10px;">
            <a href={`/tags/${encodeURIComponent(tag)}/`} aria-label={`查看标签 ${tag} 下的内容`}>查看内容 →</a>
          </div>
        </article>
      ))}
      {tags.length === 0 ? <p style="color: var(--muted);">还没有标签。</p> : null}
    </div>
  </section>
</BaseLayout>
